<script>
    require([
        'jquery',
        'mage/backend/validation'
    ], function ( $ ) {
        //variables
        var saveButton              = $('#save');
        var nextButton              = $('#Next');
        var resetButton             = $('#reset');
        var sourceStoreWrapper      = $('#source-store-wrapper');
        var targetStoreElement      = $('select[name="magento_destination_store"]');
        var targetLanguageElement   = $('select[name="straker_target_language"]');
        var sourceStoreElement      = $('select[name="magento_source_store"]');
        var sourceLanguageElement   = $('select[name="straker_source_language"]');
        var contentTabs             = $('#job_tabs_attachment_products,#job_tabs_categories,#job_tabs_cms_pages,#job_tabs_cms_blocks');
        var editForm                = $('form#edit_form');

        //functions
        function isEmpty(object) {
            return (
                typeof object === 'undefined'
                || object === null
                || ( typeof object === 'string' && $.trim(object) === '')
                || ( object instanceof jQuery && typeof object.get(0) === 'undefined' )
            );
        }

        function stopEvent(e) {
            e.stopImmediatePropagation();
            e.preventDefault();
            return false;
        }

        function triggerValidation() {

            if(!isEmpty(editForm)){
                editForm.valid();
            }
            //it removes the error icon on the first tab if the language pair set properly
            if(checkLanguageData()){
                var tabs = $('li[role="tab"]');
                if(!isEmpty(tabs) && tabs.length > 0 && !isEmpty(tabs[0])){
                    var cssError = '_error';
                    var tab = $(tabs[0]);
                    if(!isEmpty(tab)){
                        var a = tab.find('a');
                        if(!isEmpty(a)){
                            if(a.hasClass(cssError)){
                                a.removeClass(cssError);
                            }
                        }
                    }
                }
            }
        }

        function showSourceStore() {
            if(!isEmpty(sourceStoreWrapper)){
                sourceStoreWrapper.show();
            }
        }

        function hideSourceStore() {
            if(!isEmpty(sourceStoreWrapper)){
                sourceStoreWrapper.hide();
            }
        }

        function showSourceStorePicker(destinationStoreId) {
            enableAllOptions();

            if(!isEmpty(destinationStoreId)){
                disableOneOption.apply(sourceStoreElement, [sourceStoreElement, destinationStoreId]);
            }

            targetLanguageElement.val('');
            sourceStoreElement.val('');
            sourceLanguageElement.val('');

            showSourceStore();
        }

        function hideSourceStorePicker(destinationStoreId, tl, sourceStoreId, sl) {
            hideSourceStore();

            targetStoreElement.val(destinationStoreId);
            disableOneOption.apply(sourceStoreElement, [sourceStoreElement, destinationStoreId]);

            targetLanguageElement.val(tl);
            disableOneOption.apply(sourceLanguageElement, [sourceLanguageElement, tl]);

            sourceStoreElement.val(sourceStoreId);
            disableOneOption.apply(targetStoreElement, [targetStoreElement, sourceStoreId]);

            sourceLanguageElement.val(sl);
            disableOneOption.apply(targetLanguageElement, [targetLanguageElement, sl]);
        }

        function resetLanguagePairElements() {
            targetStoreElement.val('');
            targetLanguageElement.val('');
            sourceStoreElement.val('');
            sourceLanguageElement.val('');
            enableAllOptions();
            showSourceStorePicker();
        }

        function disableOneOption(selectElement, optionValue) {
            if (!(selectElement instanceof jQuery)) {
                selectElement = $(selectElement);
            }

            if (!isEmpty(selectElement.get(0)) && !isEmpty(optionValue)) {
                //enable disabled options
                enableOption(selectElement);
                //disable the option with the same value as ```optionValue```
                selectElement.find('option[value="' + optionValue + '"]').attr('disabled', true);
                //turn off error message
            }
        }

        function enableOption(element) {
            if(!(element instanceof jQuery)){
                element = $(element);
            }
            element.find('option:disabled').prop('disabled', false);
        }

        function enableAllOptions() {
            if (!isEmpty(targetStoreElement)) {
                enableOption(targetStoreElement);
            }

            if (!isEmpty(targetLanguageElement)) {
                enableOption(targetLanguageElement);
            }

            if (!isEmpty(sourceStoreElement)) {
                enableOption(sourceStoreElement);
            }

            if (!isEmpty(sourceLanguageElement)) {
                enableOption(sourceLanguageElement);
            }
        }

        function getLanguageData(name = '') {
            var data =  {
                magento_destination_store: targetStoreElement,
                magento_source_store: sourceStoreElement,
                straker_target_language: targetLanguageElement,
                straker_source_language: sourceLanguageElement
            };

            if( name.trim() === ''){
                return data;
            }else if($.inArray(name, data)){
                return data[name];
            }else{
                return {};
            }
        }

        function checkLanguageData() {
            var languageInputs = getLanguageData();
            var emptyCount = 0;
            $.each(languageInputs, function (key, element) {
                if (element instanceof jQuery && element.val() === '') {
                    emptyCount++;
                }
            });


            if (emptyCount > 0) {
                nextButton.attr('disabled', true);
                saveButton.attr('disabled', true);
            } else {
                nextButton.attr('disabled', false);
                return true;
            }
            return false;

        }

        function getStoreData(name = '') {
            var data = {
                product_data: $('input[name="products"]'),
                category_data: $('input[name="categories"]'),
                page_data: $('input[name="pages"]'),
                block_data: $('input[name="blocks"]')
            };

            if( name.trim() === ''){
                return data;
            }else if($.inArray(name, data)){
                return data[name];
            }else{
                return {};
            }
        }

        function checkStoreData() {
            var data = getStoreData();
            var empty = 0;
            $.each(data, function (key, value) {
                if (isEmpty(value.val())) {
                    empty++
                }
            });

            if (empty === 4) {
                if(!isEmpty(saveButton)){
                    saveButton.attr('disabled', true);
                }
            } else {
                if(!isEmpty(saveButton)){
                    saveButton.attr('disabled', false);
                }
                return true;
            }
            return false;

        }

        (function init() {
            if (!isEmpty(saveButton)) {
                saveButton.hide().attr('disabled', true);
            }

            if (!isEmpty(nextButton)) {
                nextButton.attr('disabled', true);
            }

            if (!isEmpty(resetButton)) {
                resetButton.hide();
            }

            if (!isEmpty(sourceStoreWrapper)) {
                sourceStoreWrapper.show();
            }

            if (!isEmpty(contentTabs)) {
                contentTabs.hide();
            }
        })();

        //============ Event listeners =============
        //when target store changed

        if (targetStoreElement !== undefined || targetStoreElement !== null) {
            targetStoreElement.on("change", function () {
                sourceStoreElement.val('');
                var destinationStoreId = $(this).val();

                if (destinationStoreId !== '') {
                    $.ajax({
                        url: '<?php echo $block->getUrl('EasyTranslationPlatform/Jobs/CheckLanguagePairs') ?>',
                        data: {
                            form_key: window.FORM_KEY,
                            target_store_id: destinationStoreId
                        },
                        showLoader: true,
                        type: 'POST'
                    }).done(function (response) {
                        if (response['store-data'] !== undefined) {
                            var storeData = response['store-data'];

                            var sourceStoreId = '';
                            var tl = '';
                            var sl = '';

                            if (!isEmpty(storeData['straker/general/destination_language'])) {
                                tl = storeData['straker/general/destination_language'];
                            }

                            if (!isEmpty(storeData['straker/general/source_language'])) {
                                sl = storeData['straker/general/source_language'];
                            }

                            if (!isEmpty(storeData['straker/general/source_store'])) {
                                sourceStoreId = storeData['straker/general/source_store'];
                            }

                            if (sourceStoreId !== '' && tl !== '' && sl !== '') {
                                //hide source store picker
                                hideSourceStorePicker(destinationStoreId, tl, sourceStoreId, sl);
                            } else {
                                // show source store picker
                                showSourceStorePicker(destinationStoreId);
                            }
                        }
                        checkLanguageData();
                        triggerValidation();
                    });
                } else {
                    resetLanguagePairElements();
                }
                triggerValidation();
            });//end of targetStoreElement.on("change" ...
        }//end of if ( targetStoreElement !== undefined || targetStoreElement !== null)

        //when target language changed
        if (!isEmpty(targetLanguageElement)) {
            targetLanguageElement.on('change', function () {
                disableOneOption.apply(this, [sourceLanguageElement, $(this).val()]);
                triggerValidation();
            })
        }

        //when source store changed
        if(!isEmpty(sourceStoreElement)){
            sourceStoreElement.on("change", function () {
                disableOneOption.apply(this, [targetStoreElement, $(this).val()]);
                triggerValidation();
            });
        }

        //when source language changed
        if (!isEmpty(sourceLanguageElement)) {
            sourceLanguageElement.on('change', function () {
                disableOneOption.apply(this, [targetLanguageElement, $(this).val()]);
                triggerValidation();
            });
        }

        $(document).ajaxSend(function (event, jqXHR, settings) {
            var destination_store_id;
            var source_store_id;

            if(!isEmpty(targetStoreElement)){
                destination_store_id = targetStoreElement.val();
            }

            if(!isEmpty(sourceStoreElement)){
                source_store_id = sourceStoreElement.val();
            }

            if (!source_store_id) {
                source_store_id = destination_store_id;
            }

            if (settings.url.toLowerCase().search('easytranslationplatform/jobs/products') > -1) {
                settings.data = settings.data + '&source_store_id=' + source_store_id + '&target_store_id=' + destination_store_id;
//                window.products_ajax_url = settings.url;
            }

            if (settings.url.toLowerCase().search('easytranslationplatform/jobs/pages') > -1) {
                settings.data = settings.data + '&source_store_id=' + source_store_id + '&target_store_id=' + destination_store_id;
            }

            if (settings.url.toLowerCase().search('easytranslationplatform/jobs/blocks') > -1) {
                settings.data = settings.data + '&source_store_id=' + source_store_id + '&target_store_id=' + destination_store_id;
            }
        });


        if(!isEmpty(nextButton)){
            nextButton.on("click", function (e) {
                e.preventDefault();
                if(!checkLanguageData()){
                    triggerValidation();
                    return stopEvent(e);
                }
                contentTabs.show();
                $('#job_tabs_attachment_products').click();
                $('#save').show();
                $('#reset').show();
                $(this).hide();
            });
        }

        if(!isEmpty(editForm)){
            editForm.on("change", "select", function () {
                if(checkLanguageData()){
                    if(!isEmpty(nextButton)) {
                        nextButton.attr('disabled', false);
                    }
                }
            });
            editForm.on("click", "input", function (e) {
                checkStoreData();
            });

        }

        if (!isEmpty(saveButton)) {
            saveButton.on("click", function (e) {
                if(!checkStoreData()){
                    return stopEvent(e);
                }
                $('body').trigger('processStart');
                $(this).attr('disabled', true);
            });
        }
    });
</script>
